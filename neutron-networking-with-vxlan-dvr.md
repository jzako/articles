# Neutron networking (ml2/vxlan/dvr)

## Network Design Goals

* Convey data
  * Control data. Generated by admin/users.
  * User data. Generated by users.
* Virtualization
  * Ability to create virtual networks over physical network
  * Isolation between different tenant networks

## Packet Flows:

* North-South Flows:
  * North — traffic out of the data centre
  * South — traffic into the data centre
* East-West Flows:
  * Traffic inside the data centre

## Network Architecture

Generally we have 3 types of nodes (physical servers):

* Control Nodes
* Network Nodes
* Compute Nodes

![](resources/images/neutron_architecture.jpg)

Control data that convey task info (i.e. create router, delete port) flows between:
* control node — network node
* control node — compute node

All message interactions are RPC calls via message queue. Rabbit MQ is used in our deployment scenario.

East-West user data flows between compute nodes and network nodes. North-South user data flows among compute/network nodes and external public network.
Without DVR(Distributed Virtual Router) enabled, only network nodes display the L3 router role, which leads to the fact that all north-south packets and cross-network east-west packets flow via network nodes, giving  too much burden to these nodes and increasing the overall risk of network node down.
DVR feature is designed to solve this problem. Key thought of DVR is making compute nodes handle east-west flow and non-snat flow and decreasing the dependency of network nodes.

Table below clearly describes changes brought by DVR.

| / | East-West: same network | East-West: different networks  | North-South: no floating ip (SNAT needed) | North-South: floating ip configured |
| :------: | :------: | :-----: | :-----: | :-----: |
| Without DVR  | CN - CN | CN - NN - CN | CN - NN - External | CN - NN - External |
| DVR enabled  | CN - CN | CN - CN | CN - NN - External | CN - External |

(CN: Compute Node; NN: Network Node)

** Without DVR **
![](resources/images/vxlan_no_dvr.jpg)

** With DVR **
![](resources/images/vxlan_with_dvr.jpg)

## Deployment Scenarios

** Scenario 1: East-West Traffic for instances using same network on same node **
![](resources/images/scenario_1.jpg)

** Scenario 2: East-West Traffic for instances using same network on different nodes **
arp ping
![](resources/images/scenario_2_arp.jpg)
data req
![](resources/images/scenario_2_data.jpg)

** Scenario 3: East-West Traffic for instances using different network on same router on same node  **
![](resources/images/scenario_3.jpg)

** Scenario 4: East-West Traffic for instances using different network on same router on different nodes **
![](resources/images/scenario_4.jpg)

** Scenario 5: North-South Traffic for instance using floating ip (outside traffic) **
![](resources/images/scenario_5.jpg)

** Scenario 6: North-South Traffic for instance using floating ip (inside traffic) **
![](resources/images/scenario_6.jpg)

** Scenario 7: North-South Traffic for instance without using floating ip **
![](resources/images/scenario_7.jpg)

